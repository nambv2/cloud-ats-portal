define(["keyword/module"],function(a){"use strict";a.registerController("DrivenCtrl",["$scope","$rootScope","$stateParams","$templateRequest","$compile","CaseService","DataService",function(a,b,c,d,e,f,g){a.projectId=c.id,a.title="DATA DRIVEN",a.driven_name="",f.list(a.projectId,function(b){a.cases=[],_.forEach(b,function(b){var c=h(b);c.length>0&&a.cases.push(b)})});var h=function(a){var b=[];return _.forEach(a.steps,function(a){_.forEach(a.params,function(c){var d=a[c];d instanceof Object&&(d=d.value);var e=d.indexOf("${"),f=d.lastIndexOf("}");if(0==e&&f==d.length-1){var g=d.substring(e+2,f);b.push(g)}})}),b},i=function(a){var b={};return _.forEach(a,function(a){b[a]=a+"_value"}),b},j=function(b){a.dataset=[];var c=h(b);a.dataset.push(i(c))},k=function(){var b=$("#add-datadriven");b.html(""),d("app/keyword/views/datadriven-modal-content.tpl.html").then(function(c){b.html(e(c)(a))})};a.clickToCase=function(b){a.current=b,a.params=h(b),null==b.data_driven?(a.driven_name="",j(a.current)):(a.dataset=[],g.get(b.data_driven._id).then(function(b){a.dataset=JSON.parse(b.data.data_source),a.driven_name=b.data.name})),k()},a.addNewRow=function(){var b=h(a.current);a.dataset.push(i(b))},a.resetData=function(){var b=a.dataset.length,c=angular.copy(a.copyDatasetInit);a.dataset.splice(0,b),a.dataset.push(c)},a.changeParamValue=function(b,c){var d=c.indexDataset,e=a.dataset[d],f=c.nameParam,g=c.$$element;for(var h in e)_.isEqual(h,f)&&(e[h]=b.trim());g.removeClass("hasnot-case")},a.createNewData=function(){var b=$('input[name="driven-name"]'),c=b.val();return c?void(null===a.current.data_driven?g.create(a.driven_name.trim(),a.dataset,a.current._id,function(b,c){$.smallBox({title:"Notification",content:"Dataset has created",color:"#296191",iconSmall:"fa fa-check bounce animated",timeout:3e3});var d={_id:b._id};a.current.data_driven=d,$("#add-datadriven").modal("hide")}):g.update(a.driven_name.trim(),a.dataset,a.current.data_driven._id,function(a,b){switch(b){case 304:$.smallBox({title:"Notification",content:"Dataset has nothing to update",color:"#296191",iconSmall:"fa fa-check bounce animated",timeout:3e3});break;case 200:$.smallBox({title:"Notification",content:"Dataset has updated",color:"#296191",iconSmall:"fa fa-check bounce animated",timeout:3e3})}$("#add-datadriven").modal("hide")})):void b.focus()},a.chooseDataDriven=function(){var a=(b.context.tenant._id,b.context.space);void 0===a&&(a={_id:null});var c="";g.list(function(a,b){_.forEach(a,function(a){c+="[ name = ",c+=a.name,c+=" | id = ",c+=a._id,c+="]"}),$.SmartMessageBox({title:"Data Driven: Select",content:"Choose your data existed",buttons:"[Done][Cancel]",input:"select",options:c},function(b,c){"Done"===b&&l(c,a)})})};var l=function(b,c){var d=b.indexOf(" | id = ")+" | id = ".length,e=b.substring(d),g=_.find(c,function(a){return a._id===e}),h={_id:g._id,name:g.name,data_source:JSON.parse(g.data_source)};a.current.data_driven=h,f.update(a.projectId,a.current,function(a,b){$("#add-datadriven").modal("hide")})}}])});
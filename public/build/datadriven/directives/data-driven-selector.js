define(["fk/module","lodash"],function(a,b){"use strict";a.registerDirective("drivenSelector",["$rootScope","DataService",function(a,c){return{restrict:"E",replace:!0,templateUrl:"build/fk/directives/new-datadriven.tpl.html",link:function(d,e,f){d.showCreateForm=!1,d.selected=d.cases[0],d.buildDataset=function(){var a=[],c=[];b.forEach(d.selected.steps,function(a){b.forEach(a.params,function(b){var d=a[b];d instanceof Object&&(d=d.value);var e=d.indexOf("${"),f=d.lastIndexOf("}");if(0==e&&f==d.length-1){var g=d.substring(e+2,f);c.push(g)}})});var e={};return b.forEach(c,function(b){e[b]=b+"_value",a.push(e)}),a},d.selectCase=function(a){d.selected=a,d.showCreateForm=!1},d.showCreateFormFn=function(){d.selected.driven&&(d.selected.driven.isNew||(d.tempDriven=d.selected.driven,d.selected.driven=void 0)),d.showCreateForm=!0},d.destroyCreateFormFn=function(){d.tempDriven&&(d.selected.driven=d.tempDriven,d.tempDriven=void 0),d.showCreateForm=!1},d.chooseDataDriven=function(){var e=a.context.tenant._id,f=a.context.space;void 0===f&&(f={_id:null}),c.list(e,f._id).then(function(a){var c="";b.forEach(a,function(a){c+="[ name = ",c+=a.name,c+=" | id = ",c+=a._id,c+="]"}),$.SmartMessageBox({title:"Data Driven: Select",content:"Choose your data existed",buttons:"[Done][Cancel]",input:"select",options:c},function(c,e){if("Done"===c){var f=e.indexOf(" | id = ")+" | id = ".length,g=e.substring(f),h=b.find(a,function(a){return a._id===g}),i={id:h._id,name:h.name,data:JSON.parse(h.data_source)};d.selected.driven=i}})})},d.createNewData=function(){var a=$(e).find('input[name="driven-name"]'),c=a.val();if(!c)return a.focus(),!1;var f=[];$("div.data-provider table thead th.filedName").each(function(a,b){var c=$(b).text().trim();f[a]=c});var g=[];$("div.data-provider table tbody tr.fieldValues").each(function(a,b){var c=[];$(b).find("td.cell").each(function(a,b){c[a]=$(b).text().trim()}),g[a]=c});var h=[];b.forEach(g,function(a){var b={};$(f).each(function(c,d){b[d]=a[c]}),h.push(b)}),d.selected.driven={name:c,data:h,isNew:!0},d.showCreateForm=!1},$(e).on("keypress",'input[name="driven-name"]',function(){var a=$(this).parent();a.hasClass("state-error")&&(a.removeClass("state-error"),a.addClass("state-success"))}),$(e).on("blur",'input[name="driven-name"]',function(){var a=$(this).val(),b=$(this).parent();a||($(this).focus(),b.addClass("state-error"),b.removeClass("state-success"))})}}}])});
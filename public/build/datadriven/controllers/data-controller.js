define(["datadriven/module","notification"],function(a){"use strict";a.registerController("DataCtrl",["$rootScope","$state","$scope","$templateRequest","$compile","CaseService","UserService","DataService",function(a,b,c,d,e,f,g,h){c.current=void 0,c.dataset=[],c.editable=!1,c.create=!1,c.datas=[],h.list(function(a,b){c.datas=a,c.datas.length>0?(c.current=c.datas[0],c.dataset=JSON.parse(c.current.data_source)):($(".data-provider").find(".driven-name").hide(),$(".data-provider").find(".edit-button").hide())});c.chooseData=function(a){c.editable=!1,c.create=!1,c.current=a,c.dataset=JSON.parse(a.data_source),c.current.name=a.name},c.clickNewDataDrivenButton=function(a){var b=$("#data-table");b.html(""),d("app/datadriven/views/data-driven.tpl.html").then(function(a){b.html(e(a)(c))}),c.dataset=[],c.current=void 0,c.editable=!0,c.create=!0},c.editDataset=function(){c.currentDataset=angular.copy(c.dataset),c.currentName=angular.copy(c.current.name),c.editable=!0},c.cancelEdit=function(){c.editable=!1,void 0===c.current||void 0===c.current._id?c.datas.length>0?(c.current=c.datas[0],c.dataset=JSON.parse(c.current.data_source),c.editable=!1,c.create=!1):(c.current=void 0,c.dataset=[],$(".data-provider").hide()):(c.dataset=c.currentDataset,c.current.name=c.currentName,c.editable=!1);var a=$(".data-provider div .driven-name");a.removeClass("has-error")},c.updateDataDriven=function(){var a=$(".data-provider div .driven-name").find("input");if(void 0===a.val()||""===a.val())return a.parent().addClass("has-error"),void a.focus();var b=[];$(".data-provider table thead th.filedName").each(function(a,c){var d=$(c).text().trim();b[a]=d});var d=[];$(".data-provider table tbody tr.fieldValues").each(function(a,b){var c=[];$(b).find("td.cell").each(function(a,b){c[a]=$(b).text().trim()}),d[a]=c});var e=[];_.forEach(d,function(a){var c={};$(b).each(function(b,d){c[d]=a[b]}),e.push(c)}),h.update(c.current.name,e,c.current._id,function(a,b){200==b&&(c.create=!1,c.editable=!1,$.smallBox({title:"Data Driven",content:"<i class='fa fa-clock-o'></i> <i>Your data driven has updated.</i>",color:"#659265",iconSmall:"fa fa-check fa-2x fadeInRight animated",timeout:2e3}),c.dataset=JSON.parse(a.data_source),c.current.data_source=a.data_source),304==b&&(c.create=!1,c.editable=!1,$.smallBox({title:"Data Driven",content:"<i class='fa fa-clock-o'></i> <i>Your data driven has nothing to update.</i>",color:"#659265",iconSmall:"fa fa-check fa-2x fadeInRight animated",timeout:2e3}))})},$("body").on("keypress",".data-provider div .driven-name input",function(){""!=$(this).val()&&$(this).parent().removeClass("has-error")}),c.createDataDriven=function(){var a=$(".data-provider div .driven-name").find("input");if(void 0===a.val()||""===a.val())return a.parent().addClass("has-error"),void a.focus();var b=[];$(".data-provider table thead th.filedName").each(function(a,c){var d=$(c).text().trim();b[a]=d});var d=[];$(".data-provider table tbody tr.fieldValues").each(function(a,b){var c=[];$(b).find("td.cell").each(function(a,b){c[a]=$(b).text().trim()}),d[a]=c});var e=[];_.forEach(d,function(a){var c={};$(b).each(function(b,d){c[d]=a[b]}),e.push(c)}),h.create(c.current.name,e,"null",function(a,b){200==b&&(c.create=!1,c.editable=!1,$.smallBox({title:"Data Driven",content:"<i class='fa fa-clock-o'></i> <i>Your data driven has created.</i>",color:"#659265",iconSmall:"fa fa-check fa-2x fadeInRight animated",timeout:2e3}),c.datas.push(a),c.current=a,c.dataset=JSON.parse(a.data_source))})},c.deleteDataDriven=function(a,b){$.SmartMessageBox({title:"Delete data driven",content:"Are you sure to delete the data driven",buttons:"[No][Yes]"},function(a){"Yes"===a&&h["delete"](c.current._id,function(a,d){200===d&&($.smallBox({title:"Data Driven",content:"<i class='fa fa-clock-o'></i> <i>Your data driven has deleted</i>",color:"#659265",iconSmall:"fa fa-check fa-2x fadeInRight animated",timeout:2e3}),c.datas.splice(b,1),c.dataset=[],c.datas.length>0?(c.current=c.datas[0],c.dataset=JSON.parse(c.current.data_source)):(c.current=void 0,c.dataset=[],$(".data-provider").hide()))}),"No"===a})}}])});